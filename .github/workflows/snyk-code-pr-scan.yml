name: Snyk Code PR scan

on:
  pull_request:
   branches: [ master ]

jobs:
  snyk-pipeline:
    runs-on: ubuntu-latest
    name: Snyk PR Scan
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    steps:
    # Checkout base ref branch
    - uses: actions/checkout@v3
      with:
        ref: ${{ github.base_ref }}
    - name: Download Snyk
      run: |
         wget -O snyk https://static.snyk.io/cli/latest/snyk-linux
         chmod +x ./snyk
         mv ./snyk /usr/local/bin/
         sudo npm install -g snyk-to-html
          
    - name: Authenticate Snyk
      run: snyk auth ${SNYK_TOKEN}
          
    - name: Run Snyk Code
      run: snyk code test --json-file-output=${{ github.workspace }}/snyk_code_baseline.json    
      continue-on-error: true
    - uses: actions/upload-artifact@v3
      with:
         name: snyk_code_baseline
         path: ${{ github.workspace }}/snyk_code_baseline.json
         
    # Checkout PR branch    
    - uses: actions/checkout@v3     
    - name: Authenticate Snyk
      run: snyk auth ${SNYK_TOKEN}   
      
    - name: Run Snyk Code
      run: |
        sleep 10s       
        snyk code test --json-file-output=${{ github.workspace }}/snyk_code_pr.json || true    
      continue-on-error: true
      
    - uses: actions/upload-artifact@v3
      with:
          name: snyk_code_pr
          path: ${{ github.workspace }}/snyk_code_pr.json
          
    - uses: actions/download-artifact@v3
      with:
        name: snyk_code_baseline
        
    - name: Check if new isuses have been introduced via the PR
      run: |
        chmod +x "${{ github.workspace }}/.github/snyk-code-pr-diff-amd64-linux"
        ls -lr "${{ github.workspace }}/.github/"        
        ${{ github.workspace }}/.github/snyk-code-pr-diff-amd64-linux ${{ github.workspace }}/snyk_code_baseline.json ${{ github.workspace }}/snyk_code_pr.json
        # Check if snyk_code_PR_diff_scan.json exists
        if [ -f ${{ github.workspace }}/snyk_code_PR_diff_scan.json ]; then
          snyk-to-html -i ${{ github.workspace }}/snyk_code_PR_diff_scan.json -o -o snyk_code_pr_results.html || true
        fi
